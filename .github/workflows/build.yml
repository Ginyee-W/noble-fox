name: Build website

on:
  workflow_call:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # IMPORTANT:
      # Do NOT pin pnpm version here, because your package.json already pins it via "packageManager": "pnpm@x.y.z"
      # Pinning here causes "Multiple versions of pnpm specified" error.
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        if: hashFiles('pnpm-lock.yaml') != ''
        run: pnpm install --frozen-lockfile

      - name: Get Hugo Version
        id: hugo
        shell: bash
        run: |
          # Read hugo_version from hugoblox.yaml, fallback to a safe default
          VERSION="0.154.4"

          if [[ -f "hugoblox.yaml" ]]; then
            v="$(awk -F: '/^[[:space:]]*hugo_version:[[:space:]]*/{print $2; exit}' hugoblox.yaml || true)"
            v="${v//\"/}"
            v="${v//\'/}"
            v="$(echo "$v" | xargs)"   # trim spaces
            if [[ -n "$v" ]]; then
              VERSION="$v"
            fi
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Hugo version: $VERSION"

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ steps.hugo.outputs.version }}
          extended: true

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Build with Hugo
        env:
          HUGO_ENVIRONMENT: production
        run: |
          hugo --gc --minify --baseURL "${{ steps.pages.outputs.base_url }}/"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./public
