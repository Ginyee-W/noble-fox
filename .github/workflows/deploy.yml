name: Deploy website to GitHub Pages

on:
  push:
    branches: ['main']
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  # Check deployment configuration
  config:
    if: github.repository_owner != 'HugoBlox'
    runs-on: ubuntu-latest
    outputs:
      deploy_host: ${{ steps.check.outputs.host }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: hugoblox.yaml
          sparse-checkout-cone-mode: false

      - name: Check deploy host
        id: check
        shell: bash
        run: |
          # Read deploy.host from hugoblox.yaml, default to github-pages
          HOST="github-pages"

          if [[ -f "hugoblox.yaml" ]]; then
            # Very small YAML parser for:
            # deploy:
            #   host: github-pages
            found="$(awk '
              $1=="deploy:" {in=1; next}
              in && $1 ~ /^[A-Za-z_].*:$/ {in=0}     # next top-level key ends deploy block
              in && $1=="host:" {print $2; exit}
            ' hugoblox.yaml || true)"

            # strip quotes if any
            found="${found//\"/}"
            found="${found//\'/}"

            if [[ -n "$found" ]]; then
              HOST="$found"
            fi
          fi

          echo "host=$HOST" >> "$GITHUB_OUTPUT"
          echo "Deployment target: $HOST"

  # Build website using reusable workflow (always runs for CI)
  build:
    needs: config
    if: github.repository_owner != 'HugoBlox'
    uses: ./.github/workflows/build.yml
    secrets: inherit

  # Deploy website to GitHub Pages hosting (only if configured)
  deploy:
    needs: [config, build]
    if: needs.config.outputs.deploy_host == 'github-pages'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
